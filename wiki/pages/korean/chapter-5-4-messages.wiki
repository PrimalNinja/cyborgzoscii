== Part D – ZOSCIIBB 서버 소스 ==

<code>
<?php

// 서버 측: messages.php

// 로컬 파일 접근을 허용하기 위해 CORS 헤더 추가
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// preflight 요청 처리
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

define("MSG_DIR", "messages/");

function listMessages($intLimit_a, $intPage_a)
{
    $arrFiles = array();
    if (is_dir(MSG_DIR))
    {
        $arrAll = scandir(MSG_DIR);
        foreach ($arrAll as $strFilename)
        {
            if (preg_match('/\\.bin$/i', $strFilename))
            {
                $arrFiles[] = $strFilename;
            }
        }
        rsort($arrFiles, SORT_NATURAL | SORT_FLAG_CASE);
    }
    $intOffset = ($intPage_a - 1) * $intLimit_a;
    $arrFiles = array_slice($arrFiles, $intOffset, $intLimit_a);
    $arrResults = array();
    foreach ($arrFiles as $strFilename)
    {
        // 파일명에서 날짜 추출 YYYYMMDDHHNNSSCC
        $strDate = substr($strFilename, 0, 14); // YYYYMMDDHHNNSS 부분 가져오기
        $intTimestamp = 0;
        if (strlen($strDate) == 14)
        {
            $intTimestamp = mktime(
                intval(substr($strDate, 8, 2)),  // 시
                intval(substr($strDate, 10, 2)), // 분
                intval(substr($strDate, 12, 2)), // 초
                intval(substr($strDate, 4, 2)),  // 월
                intval(substr($strDate, 6, 2)),  // 일
                intval(substr($strDate, 0, 4))   // 년
            );
        }
        
        $arrResults[] = array(
            "binFilename" => $strFilename,
            "date" => $intTimestamp
        );
    }
    header("Content-Type: application/json");
    echo json_encode($arrResults);
    exit;
}

function serveMessage($strFilename_a)
{
    // 보안: .bin 파일만 허용하고 디렉토리 순회 방지
    if (!preg_match('/^[0-9]{16}\.bin$/', $strFilename_a))
    {
        http_response_code(400);
        header("Content-Type: application/json");
        echo json_encode(array("error" => "잘못된 파일명"));
        exit;
    }
    
    $strFilepath = MSG_DIR . $strFilename_a;
    
    if (file_exists($strFilepath))
    {
        header('Content-Type: application/octet-stream');
        header('Content-Length: ' . filesize($strFilepath));
        readfile($strFilepath);
        exit;
    }
    else
    {
        http_response_code(404);
        header("Content-Type: application/json");
        echo json_encode(array("error" => "파일을 찾을 수 없음"));
        exit;
    }
}

if ($_SERVER['REQUEST_METHOD'] === "GET")
{
    // 메시지 파일 제공 처리
    if (isset($_GET['file']))
    {
        serveMessage($_GET['file']);
    }
    
    // 메시지 목록 처리
    if (isset($_GET['limit']))
    {
        $intLimit = intval($_GET['limit']);
        if ($intLimit < 1)
        {
            $intLimit = 1;
        }
        else if ($intLimit > 100)
        {
            $intLimit = 100;
        }
    }
    else
    {
        $intLimit = 20;
    }
    
    if (isset($_GET['page']))
    {
        $intPage = intval($_GET['page']);
        if ($intPage < 1)
        {
            $intPage = 1;
        }
    }
    else
    {
        $intPage = 1;
    }
    
    listMessages($intLimit, $intPage);
}

if ($_SERVER['REQUEST_METHOD'] === "POST" && isset($_FILES['addressfile']))
{
    $strDate = date("YmdHis");
    $intCounter = 0;
    do
    {
        $strBinFile = $strDate . sprintf("%02d", $intCounter) . ".bin";
        $strPath = MSG_DIR . $strBinFile;
        $intCounter++;
    }
    while(file_exists($strPath) && $intCounter < 100);
    
    move_uploaded_file($_FILES['addressfile']['tmp_name'], $strPath);
    
    header("Content-Type: application/json");
    echo json_encode(array("success" => true, "binFile" => $strBinFile));
    exit;
}

header('HTTP/1.1 400 Bad Request');
header("Content-Type: application/json");
echo json_encode(array("error" => "잘못된 요청"));
exit;
?>
</code>
