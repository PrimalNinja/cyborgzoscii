// CyborgZOSCII v20250805
// (c) 2025 Cyborg Unicorn Pty Ltd.
// This software is released under MIT License.

/*jsl:ignore*/

var g_arrRomData=null,g_strTextData="",g_objEncodingResult=null,g_BITTAGE=16,g_arrBinaryInputData=null;window.onload=function(){setupDropZones();setupButtons()};function calculateROMStrengthGeneral(b){var c,a=0;for(c=0;256>c;c++)0<b.romCounts[c]&&(a+=Math.log10(b.romCounts[c]));return a}function calculateROMStrengthFile(b){var c,a=0;for(c=0;256>c;c++)0<b.inputCounts[c]&&0<b.romCounts[c]&&(a+=b.inputCounts[c]*Math.log10(b.romCounts[c]));return a}
function checkEncodeReady(){var b=g_arrRomData&&(g_strTextData&&0<g_strTextData.length||g_arrBinaryInputData&&0<g_arrBinaryInputData.length);document.getElementById("verifyBtn").disabled=!b}
function displayAnalysis(b){var c,a;a="<h3>Encoding Results</h3><div class='row'><div class='col-md-6'>";a+="<h5>Input Information</h5>";a+="<table class='table table-sm analysis-table'>";a+="<colgroup><col style='width: 40%;'><col style='width: 60%;'></colgroup>";c="";c=100<b.originalText.length?b.originalText.substring(0,100)+"...":b.originalText;a+="<tr><td>>Original Input:</td><td>"+escapeHtml(c)+"</td></tr>";a+="<tr><td>>Input Length:</td><td>"+b.inputLength+" bytes</td></tr>";a+="<tr><td>>Encoding:</td><td>"+
b.encoding.toUpperCase()+"</td></tr>";a+="<tr><td>>Addresses Generated:</td><td>"+b.addressCount+"</td></tr>";a+="</table>";a+="</div>";a+=displayROMStrength(b);a+="<div class='mt-4'>";a+="<h5>Generate Address File</h5>";a+="<p>Create the encoded ZOSCII data file:</p>";a+="<button class='btn btn-success' id='generateAddressFileBtn'>Generate Address File</button>";a+="<div id='viewerResult' class='mt-3'></div>";a+="</div>";a+="<div class='col-md-6'>";a+="<h5>Address List</h5>";a+="<div style='max-height: 200px; overflow-y: auto;'>";
a+="<table class='table table-sm analysis-table'>";a+="<thead><tr><th>Index</th><th>Address (Hex)</th><th>Address (Dec)</th></tr></thead>";a+="<tbody>";for(c=0;c<Math.min(b.addresses.length,50);c++){var d=b.addresses[c];void 0!==d&&(a+="<tr>",a+="<td>"+c+"</td>",a+="<td>0x"+d.toString(16).toUpperCase()+"</td>",a+="<td>"+d+"</td>",a+="</tr>")}50<b.addresses.length&&(a+="<tr><td colspan='3'><em>... and "+(b.addresses.length-50)+" more addresses (use 'Generate Address File' to get all)</em></td></tr>");
a+="</tbody></table>";a+="</div>";a+="</div>";a+="</div>";a+="<div class='mt-4'>";a+="<h5>Character Usage</h5>";a+="<table class='table table-sm analysis-table'><thead><tr><th>Byte</th><th>Dec</th><th>ROM Count</th><th>Input Count</th><th>Char</th></tr></thead><tbody>";for(c=0;256>c;c++){var d=b.romCounts[c],e=b.inputCounts[c],g="",h="";32<=c&&126>=c?(g=String.fromCharCode(c),h=5<=d?"color:#155724;background:#d4edda;":"color:#721c24;background:#f8d7da;"):(g="&nbsp;",h=5<=d?"color:#6c757d;background:#f8f9fa;":
"color:#721c24;background:#f8d7da;");var f=c.toString(16).toUpperCase();2>f.length&&(f="0"+f);a+="<tr style='"+h+"'>";a+="<td>0x"+f+"</td>";a+="<td>"+c+"</td>";a+="<td>"+d+"</td>";a+="<td>"+e+"</td>";a+="<td>"+g+"</td>";a+="</tr>"}a+="</tbody></table></div>";document.getElementById("analysisContent").innerHTML=a;document.getElementById("generateAddressFileBtn").addEventListener("click",function(){this.disabled=!0;this.textContent="Generating...";var a,c,b;if(16===g_BITTAGE){a=new Uint8Array(2*g_objEncodingResult.addresses.length);
for(b=0;b<g_objEncodingResult.addresses.length;b++)c=g_objEncodingResult.addresses[b],a[2*b]=c&255,a[2*b+1]=c>>8&255}else if(32===g_BITTAGE){a=new Uint8Array(4*g_objEncodingResult.addresses.length);for(b=0;b<g_objEncodingResult.addresses.length;b++)c=g_objEncodingResult.addresses[b],a[4*b]=c&255,a[4*b+1]=c>>8&255,a[4*b+2]=c>>16&255,a[4*b+3]=c>>24&255}downloadFile(a,"zoscii_addresses_"+(new Date).getTime()+".bin","application/octet-stream");a="<div class='alert alert-success'><strong>Address file generated successfully!</strong><br>Binary address file downloaded. Use with separate ZOSCII viewer.";
a+="</div>";document.getElementById("viewerResult").innerHTML=a;this.disabled=!1;this.textContent="Generate Address File"})}
function displayROMStrength(b){for(var c=calculateROMStrengthGeneral(b),a=calculateROMStrengthFile(b),d=0,e=0;256>e;e++)0<b.inputCounts[e]&&d++;b=100*(d/256);e="<div class='mt-4 col-md-6'><h5>ROM Strength Analysis</h5><table class='table table-sm analysis-table'>";e+="<colgroup><col style='width: 40%;'><col style='width: 30%;'><col style='width: 30%;'></colgroup>";e+="<tr><td>General ROM Capacity:</td><td>~10^"+c.toFixed(0)+"</td><td>"+exponentToLayman(c)+"</td></tr>";e+="<tr><td>This File Security:</td><td>~10^"+
a.toFixed(0)+"</td><td>"+exponentToLayman(a)+"</td></tr>";e+="<tr><td>Characters Utilized:</td><td>"+d+" of 256 ("+b.toFixed(1)+"%)</td><td></td></tr>";e+="</table>";return e+="</div>"}function downloadFile(b,c,a){b=new Blob([b],{type:a});b=URL.createObjectURL(b);a=document.createElement("a");a.href=b;a.download=c;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(b)}
function escapeHtml(b){var c=document.createElement("div");c.textContent=b;return c.innerHTML}function exponentToLayman(b){b=Math.round(b);var c="";return c=0>=b?"1":1===b?"10":"a 1 with "+b.toLocaleString()+" zeros after it"}
function formatLargeExponent(b){var c="";return c=3>b?"~"+Math.pow(10,b).toFixed(0)+" permutations":6>b?"~"+(Math.pow(10,b)/1E3).toFixed(1)+" thousand permutations":9>b?"~"+(Math.pow(10,b)/1E6).toFixed(1)+" million permutations":12>b?"~"+(Math.pow(10,b)/1E9).toFixed(1)+" billion permutations":15>b?"~"+(Math.pow(10,b)/1E12).toFixed(1)+" trillion permutations":82>b?"More than all atoms in the observable universe (10^"+b.toFixed(0)+" permutations)":1E3>b?"Incomprehensibly massive (10^"+b.toFixed(0)+
" permutations)":1E6>b?"Beyond all physical comparison (10^"+(b/1E3).toFixed(0)+" thousand permutations)":"Astronomically secure (10^"+(b/1E6).toFixed(1)+" million permutations)"}
function setupButtons(){document.getElementById("clearBtn").addEventListener("click",function(){g_arrRomData=null;g_strTextData="";g_arrBinaryInputData=g_objEncodingResult=null;var b=document.getElementById("romDropZone");b.classList.remove("has-file");b.innerHTML="<div>Drop ROMFILE here to encode or verify quality</div>";b=document.getElementById("zosciiDropZone");b.classList.remove("has-file");b.innerHTML="<div>Drop text file or type sample message</div>";document.getElementById("textInput").value=
"";document.getElementById("analysisContent").innerHTML="<p class='text-muted'>Verify a ROM first to see quality analysis results.</p>";checkEncodeReady()});document.getElementById("verifyBtn").addEventListener("click",function(){if(g_arrRomData&&(g_strTextData||g_arrBinaryInputData)){this.disabled=!0;this.textContent="Verifying...";var b=document.getElementById("encodingSelect").value,c=null,a;16===g_BITTAGE?a=65536:32===g_BITTAGE&&(a=4294967296);var d=g_arrRomData.length;d>a&&(d=a);a=[{start:0,
size:d}];"petscii"===b?c=petsciiToAscii:"ebcdic"===b&&(c=ebcdicToAscii);c=toZOSCII(g_arrRomData,g_arrBinaryInputData||g_strTextData,a,c,42);g_arrBinaryInputData?(a="Binary file data",d=g_arrBinaryInputData.length):(a=g_strTextData,d=g_strTextData.length);g_objEncodingResult={success:!0,addresses:c.addresses,originalText:a,inputLength:d,encoding:b,addressCount:c.addresses.length,inputCounts:c.inputCounts,romCounts:c.romCounts};displayAnalysis(g_objEncodingResult);document.getElementById("analysis-tab").click();
this.disabled=!1;this.textContent="Verify ROM"}})}function setupDropZone(b,c){var a=document.querySelector(b);a.addEventListener("dragover",function(a){a.preventDefault();this.classList.add("dragover")});a.addEventListener("dragleave",function(a){a.preventDefault();this.classList.remove("dragover")});a.addEventListener("drop",function(a){a.preventDefault();this.classList.remove("dragover");a=a.dataTransfer.files;0<a.length&&c(a[0])})}
function setupDropZones(){function b(b){g_arrBinaryInputData=null;g_strTextData="";var a=new FileReader;a.onload=function(a){g_arrBinaryInputData=new Uint8Array(a.target.result);document.getElementById("textInput").value="File loaded: "+b.name+" ("+b.size+" bytes)";a=document.getElementById("zosciiDropZone");a.classList.add("has-file");a.innerHTML="<div>File loaded: "+b.name+" ("+b.size+" bytes)</div>";checkEncodeReady()};a.readAsArrayBuffer(b)}setupDropZone("#romDropZone",function(b){var a=new FileReader;
a.onload=function(a){g_arrRomData=new Uint8Array(a.target.result);a=document.getElementById("romDropZone");a.classList.add("has-file");a.innerHTML="<div>ROM file loaded: "+b.name+" ("+b.size+" bytes)</div>";checkEncodeReady()};a.readAsArrayBuffer(b)});document.getElementById("romDropZone").addEventListener("click",function(){document.getElementById("romFileInput").click()});document.getElementById("romFileInput").addEventListener("change",function(){if(0<this.files.length){var b=this.files[0],a=new FileReader;
a.onload=function(a){g_arrRomData=new Uint8Array(a.target.result);a=document.getElementById("romDropZone");a.classList.add("has-file");a.innerHTML="<div>ROM file loaded: "+b.name+" ("+b.size+" bytes)</div>";checkEncodeReady()};a.readAsArrayBuffer(b)}});setupDropZone("#zosciiDropZone",b);document.getElementById("zosciiDropZone").addEventListener("click",function(){document.getElementById("textFileInput").click()});document.getElementById("textFileInput").addEventListener("change",function(){0<this.files.length&&
b(this.files[0])});document.getElementById("textInput").addEventListener("input",function(){if(!g_arrBinaryInputData){g_strTextData=this.value;var b=document.getElementById("zosciiDropZone");g_strTextData?(b.classList.add("has-file"),b.innerHTML="<div>Text entered ("+g_strTextData.length+" characters)</div>"):(b.classList.remove("has-file"),b.innerHTML="<div>Drop text file or type sample message</div>");checkEncodeReady()}})}
function showTab(b){var c,a=document.querySelectorAll(".tab-pane");for(c=0;c<a.length;c++)a[c].classList.remove("active");a=document.querySelectorAll(".nav-link");for(c=0;c<a.length;c++)a[c].classList.remove("active");document.getElementById(b).classList.add("active");document.getElementById(b+"-tab").classList.add("active")};
