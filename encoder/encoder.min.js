// CyborgZOSCII v20250805
// (c) 2025 Cyborg Unicorn Pty Ltd.
// This software is released under MIT License.

/*jsl:ignore*/

var g_arrRomData=null,g_strTextData="",g_objEncodingResult=null,g_BITTAGE=16;$(document).ready(function(){setupDropZones();setupButtons()});function calculateROMStrengthGeneral(b){var c,a=0;for(c=0;256>c;c++)0<b.romCounts[c]&&(a+=Math.log10(b.romCounts[c]));return a}function calculateROMStrengthFile(b){var c,a=0;for(c=0;256>c;c++)0<b.inputCounts[c]&&0<b.romCounts[c]&&(a+=b.inputCounts[c]*Math.log10(b.romCounts[c]));return a}
function checkEncodeReady(){var b=g_arrRomData&&g_strTextData&&0<g_strTextData.length;$("#encodeBtn").prop("disabled",!b)}
function displayAnalysis(b){var c,a;a="<h3>Encoding Results</h3><div class='row'><div class='col-md-6'>";a+="<h5>Input Information</h5>";a+="<table class='table table-sm analysis-table'>";c="";c=100<b.originalText.length?b.originalText.substring(0,100)+"...":b.originalText;a+="<tr><td><strong>Original Text:</strong></td><td>"+escapeHtml(c)+"</td></tr>";a+="<tr><td><strong>Text Length:</strong></td><td>"+b.originalText.length+" characters</td></tr>";a+="<tr><td><strong>Encoding:</strong></td><td>"+
b.encoding.toUpperCase()+"</td></tr>";a+="<tr><td><strong>Addresses Generated:</strong></td><td>"+b.addressCount+"</td></tr>";a+="</table>";a+="</div>";a+="<div class='col-md-6'>";a+="<h5>Address List</h5>";a+="<div style='max-height: 200px; overflow-y: auto;'>";a+="<table class='table table-sm analysis-table'>";a+="<thead><tr><th>Index</th><th>Address (Hex)</th><th>Address (Dec)</th></tr></thead>";a+="<tbody>";for(c=0;c<Math.min(b.addresses.length,50);c++){var e=b.addresses[c];void 0!==e&&(a+="<tr>",
a+="<td>"+c+"</td>",a+="<td>0x"+e.toString(16).toUpperCase()+"</td>",a+="<td>"+e+"</td>",a+="</tr>")}50<b.addresses.length&&(a+="<tr><td colspan='3'><em>... and "+(b.addresses.length-50)+" more addresses (use 'Generate Address File' to get all)</em></td></tr>");a+="</tbody></table>";a+="</div>";a+="</div>";a+="</div>";a+="<div class='mt-4'>";a+="<h5>Generate Address File</h5>";a+="<p>Create the encoded ZOSCII data file:</p>";a+="<button class='btn btn-success' id='generateAddressFileBtn'>Generate Address File</button>";
a+="<div id='viewerResult' class='mt-3'></div>";a+="</div>";a+="<div class='mt-4'>";a+=displayROMStrength(b);a+="<table class='table table-sm analysis-table'><thead><tr><th>Byte</th><th>Dec</th><th>ROM Count</th><th>Input Count</th><th>Char</th></tr></thead><tbody>";for(c=0;256>c;c++){var e=b.romCounts[c],d=b.inputCounts[c],g="",h="";32<=c&&126>=c?(g=String.fromCharCode(c),h=5<=e?"color:#155724;background:#d4edda;":"color:#721c24;background:#f8d7da;"):(g="&nbsp;",h=5<=e?"color:#6c757d;background:#f8f9fa;":
"color:#721c24;background:#f8d7da;");var f=c.toString(16).toUpperCase();2>f.length&&(f="0"+f);a+="<tr style='"+h+"'>";a+="<td>0x"+f+"</td>";a+="<td>"+c+"</td>";a+="<td>"+e+"</td>";a+="<td>"+d+"</td>";a+="<td>"+g+"</td>";a+="</tr>"}a+="</tbody></table></div>";$("#analysisContent").html(a);$("#generateAddressFileBtn").click(function(){$(this).prop("disabled",!0).text("Generating...");var a,b,c;if(16===g_BITTAGE){a=new Uint8Array(2*g_objEncodingResult.addresses.length);for(c=0;c<g_objEncodingResult.addresses.length;c++)b=
g_objEncodingResult.addresses[c],a[2*c]=b&255,a[2*c+1]=b>>8&255}else if(32===g_BITTAGE){a=new Uint8Array(4*g_objEncodingResult.addresses.length);for(c=0;c<g_objEncodingResult.addresses.length;c++)b=g_objEncodingResult.addresses[c],a[4*c]=b&255,a[4*c+1]=b>>8&255,a[4*c+2]=b>>16&255,a[4*c+3]=b>>24&255}downloadFile(a,"zoscii_addresses_"+(new Date).getTime()+".bin","application/octet-stream");a="<div class='alert alert-success'><strong>Address file generated successfully!</strong><br>Binary address file downloaded. Use with separate ZOSCII viewer.";
a+="</div>";$("#viewerResult").html(a);$(this).prop("disabled",!1).text("Generate Address File")})}
function displayROMStrength(b){for(var c=calculateROMStrengthGeneral(b),a=calculateROMStrengthFile(b),e=0,d=0;256>d;d++)0<b.inputCounts[d]&&e++;b=100*(e/256);d="<div class='mt-4 col-md-6'><h5>ROM Strength Analysis</h5><table class='table table-sm analysis-table'>";d+="<tr><td>General ROM Capacity:</td><td>~10^"+c.toFixed(0)+"</td><td>"+exponentToLayman(c)+"</td></tr>";d+="<tr><td>This File Security:</td><td>~10^"+a.toFixed(0)+"</td><td>"+exponentToLayman(a)+"</td></tr>";d+="<tr><td>Characters Utilized:</td><td>"+
e+" of 256 ("+b.toFixed(1)+"%)</td><td></td></tr>";d+="</table>";return d+="</div>"}function downloadFile(b,c,a){b=new Blob([b],{type:a});b=URL.createObjectURL(b);a=document.createElement("a");a.href=b;a.download=c;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(b)}function escapeHtml(b){var c=document.createElement("div");c.textContent=b;return c.innerHTML}
function exponentToLayman(b){b=Math.round(b);var c="";return c=0>=b?"1":1===b?"10":"a 1 with "+b.toLocaleString()+" zeros after it"}
function formatLargeExponent(b){var c="";return c=3>b?"~"+Math.pow(10,b).toFixed(0)+" permutations":6>b?"~"+(Math.pow(10,b)/1E3).toFixed(1)+" thousand permutations":9>b?"~"+(Math.pow(10,b)/1E6).toFixed(1)+" million permutations":12>b?"~"+(Math.pow(10,b)/1E9).toFixed(1)+" billion permutations":15>b?"~"+(Math.pow(10,b)/1E12).toFixed(1)+" trillion permutations":82>b?"More than all atoms in the observable universe (10^"+b.toFixed(0)+" permutations)":1E3>b?"Incomprehensibly massive (10^"+b.toFixed(0)+
" permutations)":1E6>b?"Beyond all physical comparison (10^"+(b/1E3).toFixed(0)+" thousand permutations)":"Astronomically secure (10^"+(b/1E6).toFixed(1)+" million permutations)"}
function setupButtons(){$("#clearBtn").click(function(){g_arrRomData=null;g_strTextData="";g_objEncodingResult=null;$("#romDropZone").removeClass("has-file").html("<div>Drop ROMFILE here to encode ZOSCII</div>");$("#zosciiDropZone").removeClass("has-file").html("<div>Drop ZOSCII data here</div>");$("#textInput").val("");$("#analysisContent").html("<p class='text-muted'>Encode some data first to see analysis results.</p>");checkEncodeReady()});$("#encodeBtn").click(function(){if(g_arrRomData&&g_strTextData){$(this).prop("disabled",
!0).text("Encoding...");var b=$("#encodingSelect").val(),c=null,a;16===g_BITTAGE?a=65536:32===g_BITTAGE&&(a=4294967296);var e=g_arrRomData.length;e>a&&(e=a);a=[{start:0,size:e}];"petscii"===b?c=petsciiToAscii:"ebcdic"===b&&(c=ebcdicToAscii);c=toZOSCII(g_arrRomData,g_strTextData,a,c,42);g_objEncodingResult={success:!0,addresses:c.addresses,originalText:g_strTextData,encoding:b,addressCount:c.addresses.length,inputCounts:c.inputCounts,romCounts:c.romCounts};displayAnalysis(g_objEncodingResult);$("#analysis-tab").click();
$(this).prop("disabled",!1).text("Encode")}})}function setupDropZone(b,c){var a=$(b);a.on("dragover",function(a){a.preventDefault();$(this).addClass("dragover")});a.on("dragleave",function(a){a.preventDefault();$(this).removeClass("dragover")});a.on("drop",function(a){a.preventDefault();$(this).removeClass("dragover");a=a.originalEvent.dataTransfer.files;0<a.length&&c(a[0])})}
function setupDropZones(){setupDropZone("#romDropZone",function(b){var c=new FileReader;c.onload=function(a){g_arrRomData=new Uint8Array(a.target.result);$("#romDropZone").addClass("has-file").html("<div>ROM file loaded: "+b.name+" ("+b.size+" bytes)</div>");checkEncodeReady()};c.readAsArrayBuffer(b)});setupDropZone("#zosciiDropZone",function(b){var c=new FileReader;c.onload=function(a){g_strTextData=a.target.result;$("#textInput").val(g_strTextData);$("#zosciiDropZone").addClass("has-file").html("<div>Text file loaded: "+
b.name+"</div>");checkEncodeReady()};c.readAsText(b)});$("#textInput").on("input",function(){(g_strTextData=$(this).val())?$("#zosciiDropZone").addClass("has-file").html("<div>Text entered ("+g_strTextData.length+" characters)</div>"):$("#zosciiDropZone").removeClass("has-file").html("<div>Drop ZOSCII data here</div>");checkEncodeReady()})};
