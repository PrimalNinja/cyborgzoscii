// CyborgZOSCII v20250805
// (c) 2025 Cyborg Unicorn Pty Ltd.
// This software is released under MIT License.

/*jsl:ignore*/

var g_arrDecodedMsgs=[],g_arrMessageMeta=[],g_arrUserRom=null,g_intCurrentPage=1,g_intPageSize=10,g_objCharMap={},g_objLastAddrFile=null,g_orwellInspiredQuotes="The truth becomes whatever those in power declare it to be.;In a world of constant surveillance, privacy becomes rebellion.;When words lose their meaning, thought becomes impossible.;The past is malleable when those who control it rewrite history.;Freedom is the right to tell people what they do not want to hear.;In times of universal deceit, speaking truth becomes a revolutionary act.;The most effective way to destroy people is to deny their understanding of history.;Power corrupts, but absolute power creates its own reality.;When everyone is watched, no one is truly free.;The manipulation of language is the manipulation of thought itself.;In a surveillance state, paranoia becomes rational behavior.;The greatest enemy of clear thinking is the illusion of knowledge.;When the government controls information, it controls the people.;Rebellion begins with a single thought kept secret.;The price of freedom is eternal vigilance against those who would take it.;In a world without privacy, love becomes an act of defiance.;Those who control the present control the past and future.;The destruction of words is the destruction of ideas.;Power seeks to make the abnormal seem normal.;When questioning authority becomes criminal, authority has become criminal.;The most dangerous person to a tyrant is someone who can think for themselves.;In totalitarian systems, loyalty is measured by blind obedience.;The individual mind is the last refuge of freedom.;When truth becomes treason, the state has lost its legitimacy.;The constant rewriting of history makes all knowledge uncertain.;Fear is the most powerful tool of oppression.;In a monitored society, solitude becomes precious and rare.;The corruption of language leads to the corruption of thought.;When everyone must conform, authenticity becomes rebellion.;The state's greatest victory is making citizens police themselves.;In the absence of truth, propaganda fills the void.;The most insidious tyranny is the one that claims to protect you.;When the past is erased, the future can be rewritten at will.;Dissent is the highest form of patriotism in a free society.;The price of comfort is often the surrender of liberty.;In a world of lies, the truth-teller becomes an outlaw.;Power maintains itself by keeping people ignorant and divided.;The destruction of memory is the destruction of identity.;When authority cannot be questioned, it ceases to be legitimate.;The individual conscience is the last check on absolute power.;In surveillance states, everyone becomes both watched and watcher.;The manipulation of facts creates a malleable reality.;When freedom of thought dies, humanity dies with it.;The state's ideal citizen thinks only what they are told to think.;In the war against truth, the first casualty is language itself.;The most dangerous book is the one that makes you question everything.;When privacy disappears, so does the possibility of dissent.;The rewriting of history is the engineering of the future.;In totalitarian systems, love of truth becomes a form of mental illness.;The ultimate goal of tyranny is to make resistance inconceivable.".split(";");
function buildCharacterMap(){g_objCharMap={};for(var a=0;a<g_arrUserRom.length;a++){var b=g_arrUserRom[a];g_objCharMap[b]||(g_objCharMap[b]=[]);g_objCharMap[b].push(a)}console.log("Character map built:",Object.keys(g_objCharMap).length,"unique characters")}
function decodeMessagesForPage(){console.log("Decoding messages for page, ROM loaded:",null!==g_arrUserRom);console.log("Messages to decode:",g_arrMessageMeta.length);g_arrDecodedMsgs=[];var a=g_arrMessageMeta.slice(0,g_intPageSize),b=0;if(0===a.length)console.log("No messages to decode"),renderMessages([],g_intCurrentPage);else{var d;for(d=0;d<a.length;d++)(function(c){$.ajax({url:"messages/"+c.binFilename,method:"GET",xhrFields:{responseType:"arraybuffer"},success:function(d){var f=new Uint8Array(d);
d=[];var g;for(g=0;g+1<f.length;g+=2)d.push(f[g]|f[g+1]<<8);f="";for(g=0;g<d.length;g++){var h=d[g];g_arrUserRom&&h<g_arrUserRom.length&&(f+=String.fromCharCode(g_arrUserRom[h]))}validateFile(f,0.9)||(f=getRandomQuote());g_arrDecodedMsgs.push({message:f,meta:c});b++;b===a.length&&(g_arrDecodedMsgs.sort(function(a,b){return(b.meta.date||0)-(a.meta.date||0)}),renderMessages(g_arrDecodedMsgs,g_intCurrentPage))}})})(a[d])}}
function getRandomAddressForChar(a){if(!g_objCharMap[a]||0===g_objCharMap[a].length)return-1;a=g_objCharMap[a];var b=Math.floor(Math.random()*a.length);return a[b]}function getRandomQuote(){var a=Math.floor(Math.random()*g_orwellInspiredQuotes.length);return g_orwellInspiredQuotes[a]}function showDropZone(){$("#divMessageEntry").hide();$("#divMessageList").hide();$("#divPagination").hide();$("#divDropZone").show()}
function showMessages(){$("#divDropZone").hide();$("#divMessageEntry").show();$("#divMessageList").show();$("#divPagination").show();$("#txtMessage").focus()}function validateFile(a,b){if(0===a.length)return!1;var d=0,c;for(c=0;c<a.length;c++){var e=a.charCodeAt(c);32<=e&&126>=e&&d++}return d/a.length>=b}
function decodeAndShow(a){var b=new FileReader;b.onload=function(b){var c=new Uint8Array(b.target.result);b=[];var e;for(e=0;e+1<c.length;e+=2)b.push(c[e]|c[e+1]<<8);e="";for(c=0;c<b.length;c++){var f=b[c];g_arrUserRom&&f<g_arrUserRom.length&&(e+=String.fromCharCode(g_arrUserRom[f]))}renderMessages([{message:e,meta:{filename:a.name}}],1)};b.readAsArrayBuffer(a);showMessages()}
function renderMessages(a,b){var d=$("#divMessageList").empty();if(0===a.length)d.append($("<div>").addClass("msg-bubble").text("No decodable messages for your ROM."));else for(var c=0;c<a.length;c++)c>=g_intPageSize||d.append($("<div>").addClass("msg-bubble").text(a[c].message));$("#divMessageList").show();$("#divPagination").show();$("#spanPageInfo").text("Page "+b);$("#btnPrev").prop("disabled",1>=b);$("#btnNext").prop("disabled",g_arrMessageMeta.length<g_intPageSize);showMessages()}
function fetchMessageMetas(a){console.log("Fetching messages for page:",a);$.getJSON("messages.php?limit="+g_intPageSize+"&page="+a).done(function(a){console.log("Fetched metadata:",a);console.log("Number of messages:",a.length);0===a.length?(console.log("No messages found"),renderMessages([],g_intCurrentPage)):(g_arrMessageMeta=a,decodeMessagesForPage())}).fail(function(a,d,c){console.error("Failed to fetch messages:",d,c);console.error("Response:",a.responseText);alert("Failed to load messages: "+
d+"\nCheck console for details");showDropZone()})}
$("#btnSubmit").click(function(){var a,b,d=$("#txtMessage").val().trim();if(0===d.length)alert("Please enter a message");else if(g_arrUserRom){var c=[];for(b=0;b<d.length;b++)a=d.charCodeAt(b),a=getRandomAddressForChar(a),-1!==a&&c.push(a);if(0===c.length)alert("No characters from your message were found in the ROM");else{d=new Uint8Array(2*c.length);for(b=0;b<c.length;b++)a=c[b],d[2*b]=a&255,d[2*b+1]=a>>8&255;b=new Blob([d],{type:"application/octet-stream"});c=new FormData;c.append("addressfile",
b,"message.bin");$.ajax({url:"messages.php",type:"POST",data:c,processData:!1,contentType:!1,success:function(a){console.log("Message submitted:",a);$("#txtMessage").val("");fetchMessageMetas(g_intCurrentPage)},error:function(a,b,c){console.error("Upload failed:",c);alert("Failed to submit message: "+c)}})}}else alert("ROM not loaded")});$("#divDropZone").on("dragover",function(a){a.preventDefault();$(this).addClass("dragover")});$("#divDropZone").on("dragleave",function(a){a.preventDefault();$(this).removeClass("dragover")});
$("#divDropZone").on("drop",function(a){a.preventDefault();$(this).removeClass("dragover");a=a.originalEvent.dataTransfer.files;if(0<a.length){a=a[0];var b=new FileReader;b.onload=function(a){g_arrUserRom=new Uint8Array(a.target.result);buildCharacterMap();g_intCurrentPage=1;fetchMessageMetas(g_intCurrentPage)};b.readAsArrayBuffer(a)}});$("#btnNext").click(function(){g_intCurrentPage++;fetchMessageMetas(g_intCurrentPage)});$("#btnPrev").click(function(){1<g_intCurrentPage&&(g_intCurrentPage--,fetchMessageMetas(g_intCurrentPage))});
showDropZone();
