<!DOCTYPE html>
<html>
<head>
    <title>ZOSCIICHAT Local Client</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body 
		{ 
			font-family: Arial, sans-serif; 
			margin: 0; 
			padding: 0; 
			overflow: none;
		}
		.channel-container 
		{
			display: flex;
			align-items: center;
			margin-bottom: 8px;
		}
		.drop-zone { 
			border: 3px dashed #ccc; 
			border-radius: 10px; 
			margin: 20px 20px 20px 20px;
			width: (100% - 40px); 
			height: calc(100vh - 100px);
			text-align: center; 
			font-size: 24px; 
			cursor: pointer; /* Already there - good! */
			color: #ccc; 
			display: flex; 
			align-items: center; 
			justify-content: center; 
			transition: all 0.3s ease; 
			margin-bottom: 20px; 
		}

		.drop-zone:hover {
			border-color: #007bff;
			color: #007bff;
			background-color: #f8f9fa;
		}
        .drop-zone.dragover { 
            border-color: #007bff; 
            color: #007bff; 
            background-color: #f8f9fa; 
        }
        .drop-zone.has-file { 
            border-color: #28a745; 
            color: #28a745; 
            background-color: #d4edda; 
        }
        #divMessageList {
            max-width: 680px; 
            margin: 60px auto 0 auto; 
            padding: 0 15px;
        }
        .msg-bubble {
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            padding: 16px; 
            margin-bottom: 16px; 
            word-break: break-word;
        }
		#divPagination {
			text-align: center;
			margin: 16px 0;
		}
		#divPagination button {
			margin: 0 8px;
			padding: 8px 18px;
			border-radius: 4px;
			font-size: 1rem;
			cursor: pointer;
			background-color: #6c757d;
			color: white;
			border: none;
		}
		#spanPageInfo {
			margin: 0 8px;
			display: inline-block;
		}
        #divPagination button:disabled {
            background-color: #ccc;
        }
        #divMessageEntry {
            max-width: 680px; 
            margin: 20px auto; 
            padding: 0 15px;
        }
        .message-entry-container {
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 16px; 
            border-radius: 8px; 
            margin-bottom: 16px;
        }
        #txtMessage {
            width: 100%; 
            height: 80px; 
            padding: 8px; 
            font-family: monospace; 
            resize: vertical; 
            box-sizing: border-box; 
            border: 1px solid #ced4da; 
            border-radius: 4px;
        }
        #txtMessage:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        #btnRefresh {
			margin-left: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-top: 0px;
            cursor: pointer;
        }
        #btnSubmit {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-top: 8px;
            cursor: pointer;
        }
		#txtChannelNumber 
		{
			width: calc(100% - 100px);
			padding: 8px;
			border: 1px solid #ced4da;
			border-radius: 4px;
		}
        #txtServerUrl
		{ 
			width: 100%; 
			padding: 8px; 
			margin-bottom: 8px; 
			border: 1px solid #ced4da; 
			border-radius: 4px; 
		}
    </style>
</head>
<body>
    <div id="divLanding" style="display:none;">
		<input type="text" id="txtServerUrl" placeholder="Enter ZOSCIICHAT server URL (e.g., https://example.com/zosciichat)">
        <div id="divDropZone" class="drop-zone">Drop ROMFILE here to ZOSCIICHAT<br>or click to browse<br>
		
		<br><br>If security is important to you:<br><br>Only obtain ZOSCIICHAT from the official ZOSCII GitHub repository https://github.com/PrimalNinja/cyborgzoscii
		
		<br><br>run ZOSCIICHAT locally (save it from GitHub and run it locally using your browser)
		
		<br><br>Your messages can only be read by those with the same ROM. Only share ROMs with those you trust - they can also share your ROMs. Use a good entropy ROM (e.g. a selfie, family photo, favourite actor) - you can use the ROM verifier if you want to check how secure your ROM is. Your messages are NOT stored on the server but the means to recreate your messages with a copy of your ROM is. What that means is your messages are 100% secure even if the server is compromised, but trust comes down to the people you share your ROMs with. If you use this program to store your data and don't share your ROM, it is 100% secure also - and if you lose your ROM, you will never be able to decode your data. Note if the server is gone, you can also lose your data if you didn't store it elsewhere also.
		
		<br><br>Disclaimer: By using this software, you acknowledge that Cyborg Unicorn Pty Ltd and associated developers are not responsible for any outcomes, including financial losses or data loss, resulting from use or misuse of this software. Risks include losing ROM files (making encoded data unrecoverable), using low-entropy ROMs (compromising security), or running in untrusted environments. The software outputs encoded data as binary files, which can only be decoded using the correct ROM file. Cyborg Unicorn Pty Ltd will publish any discovered security issues on the official website or GitHub repository. This software is provided "as is" under the MIT License with no warranties. See the MIT LICENSE file for full terms.</div>
        <input type="file" id="fileInput" style="display: none;" accept=".bin,.jpg,.png,.pdf,.txt,*">
    </div>
    <div id="divMessageEntry" style="display:none;">
        <div class="message-entry-container">
			<div class="channel-container">
				<input type="text" id="txtChannelNumber" placeholder="Enter channel number" value="1">
				<button id="btnRefresh">Refresh</button>
			</div>
            <textarea id="txtMessage" placeholder="Enter your message..."></textarea>
            <button id="btnSubmit">Post Message</button>
        </div>
    </div>
    <div id="divMessageList" style="display:none;"></div>
    <div id="divPagination" style="display:none;">
        <button id="btnPrev">Prev</button>
        <span id="spanPageInfo"></span>
        <button id="btnNext">Next</button>
    </div>
    <script>
var g_arrDecodedMsgs = [];
var g_arrMessageMeta = [];
var g_arrUserRom = null;
var g_intCurrentPage = 1;
var g_intPageSize = 10;
var g_objCharMap = {};
var g_objLastAddrFile = null;
var g_strServerEndpoint = '';
var g_strChannelNumber = '1';

var g_orwellInspiredQuotes = [
	"The truth becomes whatever those in power declare it to be.",
	"In a world of constant surveillance, privacy becomes rebellion.",
	"When words lose their meaning, thought becomes impossible.",
	"The past is malleable when those who control it rewrite history.",
	"Freedom is the right to tell people what they do not want to hear.",
	"In times of universal deceit, speaking truth becomes a revolutionary act.",
	"The most effective way to destroy people is to deny their understanding of history.",
	"Power corrupts, but absolute power creates its own reality.",
	"When everyone is watched, no one is truly free.",
	"The manipulation of language is the manipulation of thought itself.",
	"In a surveillance state, paranoia becomes rational behavior.",
	"The greatest enemy of clear thinking is the illusion of knowledge.",
	"When the government controls information, it controls the people.",
	"Rebellion begins with a single thought kept secret.",
	"The price of freedom is eternal vigilance against those who would take it.",
	"In a world without privacy, love becomes an act of defiance.",
	"Those who control the present control the past and future.",
	"The destruction of words is the destruction of ideas.",
	"Power seeks to make the abnormal seem normal.",
	"When questioning authority becomes criminal, authority has become criminal.",
	"The most dangerous person to a tyrant is someone who can think for themselves.",
	"In totalitarian systems, loyalty is measured by blind obedience.",
	"The individual mind is the last refuge of freedom.",
	"When truth becomes treason, the state has lost its legitimacy.",
	"The constant rewriting of history makes all knowledge uncertain.",
	"Fear is the most powerful tool of oppression.",
	"In a monitored society, solitude becomes precious and rare.",
	"The corruption of language leads to the corruption of thought.",
	"When everyone must conform, authenticity becomes rebellion.",
	"The state's greatest victory is making citizens police themselves.",
	"In the absence of truth, propaganda fills the void.",
	"The most insidious tyranny is the one that claims to protect you.",
	"When the past is erased, the future can be rewritten at will.",
	"Dissent is the highest form of patriotism in a free society.",
	"The price of comfort is often the surrender of liberty.",
	"In a world of lies, the truth-teller becomes an outlaw.",
	"Power maintains itself by keeping people ignorant and divided.",
	"The destruction of memory is the destruction of identity.",
	"When authority cannot be questioned, it ceases to be legitimate.",
	"The individual conscience is the last check on absolute power.",
	"In surveillance states, everyone becomes both watched and watcher.",
	"The manipulation of facts creates a malleable reality.",
	"When freedom of thought dies, humanity dies with it.",
	"The state's ideal citizen thinks only what they are told to think.",
	"In the war against truth, the first casualty is language itself.",
	"The most dangerous book is the one that makes you question everything.",
	"When privacy disappears, so does the possibility of dissent.",
	"The rewriting of history is the engineering of the future.",
	"In totalitarian systems, love of truth becomes a form of mental illness.",
	"The ultimate goal of tyranny is to make resistance inconceivable."
];

// helpers

function buildCharacterMap()
{
	g_objCharMap = {};
	
	for (var i = 0; i < g_arrUserRom.length; i++)
	{
		var charCode = g_arrUserRom[i];
		if (!g_objCharMap[charCode])
		{
			g_objCharMap[charCode] = [];
		}
		g_objCharMap[charCode].push(i);
	}
	
	console.log("Character map built:", Object.keys(g_objCharMap).length, "unique characters");
}

function decodeMessagesForPage()
{
	console.log("Decoding messages for page, ROM loaded:", g_arrUserRom !== null);
	console.log("Messages to decode:", g_arrMessageMeta.length);
	
	g_arrDecodedMsgs = [];
	var arrToDecode = g_arrMessageMeta.slice(0, g_intPageSize);
	var intDecoded = 0;
	
	if (arrToDecode.length === 0)
	{
		console.log("No messages to decode");
		renderMessages([], g_intCurrentPage);
		return;
	}
	
	var intI;
	for (intI = 0; intI < arrToDecode.length; intI++)
	{
		(function(objMeta_a)
		{
			makeAjaxRequest(g_strServerEndpoint + '/index.php?channel=' + g_strChannelNumber + '&file=' + objMeta_a.binFilename,
				{method: 'GET', responseType: 'arraybuffer'},
				function(objData_a)
				{
					var arrRaw = new Uint8Array(objData_a);
					var arrAddresses = [];
					var intJ;
					
					for (intJ = 0; intJ + 1 < arrRaw.length; intJ += 2)
					{
						arrAddresses.push(arrRaw[intJ] | (arrRaw[intJ + 1] << 8));
					}
					
					var strMessage = "";
					for (intJ = 0; intJ < arrAddresses.length; intJ++)
					{
						var intAddress = arrAddresses[intJ];
						if (g_arrUserRom && intAddress < g_arrUserRom.length)
						{
							strMessage += String.fromCharCode(g_arrUserRom[intAddress]);
						}
					}

					if (validateFile(strMessage, 1))
					{
						g_arrDecodedMsgs.push({message: strMessage, meta: objMeta_a});
					}
					else
					{
						strMessage = getRandomQuote();
						g_arrDecodedMsgs.push({message: strMessage, meta: objMeta_a});
					}
					
					intDecoded++;
					if (intDecoded === arrToDecode.length)
					{
						g_arrDecodedMsgs.sort(function(a, b)
						{
							return (b.meta.date || 0) - (a.meta.date || 0);
						});
						
						renderMessages(g_arrDecodedMsgs, g_intCurrentPage);
					}
				},
				function(strError_a)
				{
					console.error("Failed to fetch message:", strError_a);
				}
			);
		})(arrToDecode[intI]);
	}
}

function getRandomAddressForChar(charCode_a)
{
	if (!g_objCharMap[charCode_a] || g_objCharMap[charCode_a].length === 0)
	{
		return -1;
	}
	
	var arrAddresses = g_objCharMap[charCode_a];
	var intRandomIndex = Math.floor(Math.random() * arrAddresses.length);
	return arrAddresses[intRandomIndex];
}

function getRandomQuote() 
{
  var intRandomIndex = Math.floor(Math.random() * g_orwellInspiredQuotes.length);
  return g_orwellInspiredQuotes[intRandomIndex];
}

function showDropZone()
{
	document.getElementById("divMessageEntry").style.display = "none";
	document.getElementById("divMessageList").style.display = "none";
	document.getElementById("divPagination").style.display = "none";
	document.getElementById("txtChannelNumber").style.display = "none";

	document.getElementById("txtServerUrl").style.display = "block";
	document.getElementById("divLanding").style.display = "block";
}

function showMessages()
{
	document.getElementById("divLanding").style.display = "none";
	document.getElementById("txtServerUrl").style.display = "none";

	document.getElementById("divMessageEntry").style.display = "block";
	document.getElementById("divMessageList").style.display = "block";
	document.getElementById("divPagination").style.display = "block";
	document.getElementById("txtChannelNumber").style.display = "block";
	document.getElementById("txtMessage").focus();
}

function validateFile(strDecoded_a, floatMinPercentage_a)
{
	if (strDecoded_a.length === 0) return false;
	
	var intVisibleAsciiCount = 0;
	var intI;
	
	for (intI = 0; intI < strDecoded_a.length; intI++)
	{
		var intCharCode = strDecoded_a.charCodeAt(intI);
		// Visible ASCII characters are 32-126 (space through tilde)
		if (intCharCode >= 32 && intCharCode <= 126)
		{
			intVisibleAsciiCount++;
		}
	}
	
	var floatActualPercentage = intVisibleAsciiCount / strDecoded_a.length;
	return floatActualPercentage >= floatMinPercentage_a;
}

// rendering

function decodeAndShow(objAddrFile_a)
{
	var objReader = new FileReader();
	
	objReader.onload = function(e)
	{
		var arrRaw = new Uint8Array(e.target.result);
		var arrAddresses = [];
		var intI;
		
		for (intI = 0; intI + 1 < arrRaw.length; intI += 2)
		{
			arrAddresses.push(arrRaw[intI] | (arrRaw[intI + 1] << 8));
		}
		
		var intJ;
		var strDecoded = "";

		for (intJ = 0; intJ < arrAddresses.length; intJ++)
		{
			var addr = arrAddresses[intJ];
			if (g_arrUserRom && addr < g_arrUserRom.length)
			{
				strDecoded += String.fromCharCode(g_arrUserRom[addr]);
			}
		}

		// if (!validateFile(strDecoded, 1))
		// {
			// alert("This message does not look valid (it must have at least one character that appears three times).");
			// showDropZone();
			// return;
		// }

		renderMessages([{ 
			message: strDecoded,
			meta: {filename: objAddrFile_a.name}
		}], 1);
	};
	
	objReader.readAsArrayBuffer(objAddrFile_a);
	showMessages();
}

function renderMessages(arrList_a, intPage_a)
{
	var objDiv;
	var objMessageList = document.getElementById("divMessageList");
	objMessageList.innerHTML = "";
	
	if (arrList_a.length === 0)
	{
		objDiv = document.createElement("div");
		objDiv.className = "msg-bubble";
		objDiv.textContent = "No decodable messages for your ROM.";
		objMessageList.appendChild(objDiv);
	}
	else
	{
		for (var intI = 0; intI < arrList_a.length; intI++)
		{
			if (intI >= g_intPageSize)
			{
				break;
			}
			else
			{
				objDiv = document.createElement("div");
				objDiv.className = "msg-bubble";
				objDiv.textContent = arrList_a[intI].message;
				objMessageList.appendChild(objDiv);
			}
		}
	}
	
	document.getElementById("divMessageList").style.display = "block";
	document.getElementById("divPagination").style.display = "block";
	document.getElementById("spanPageInfo").textContent = "Page " + intPage_a;
	document.getElementById("btnPrev").disabled = intPage_a <= 1;
	document.getElementById("btnNext").disabled = g_arrMessageMeta.length < g_intPageSize;
	
	showMessages();
}

// webservices

function fetchMessageMetas(intPage_a)
{
    console.log("Fetching messages for page:", intPage_a);
    
    getJSON(g_strServerEndpoint + "/index.php?channel=" + g_strChannelNumber + "&limit=" + g_intPageSize + "&page=" + intPage_a, 
        function(arrMeta_a) 
        {
            console.log("Fetched metadata:", arrMeta_a);
            console.log("Number of messages:", arrMeta_a.length);
            
            if (arrMeta_a.length === 0)
            {
                console.log("No messages found");
                renderMessages([], g_intCurrentPage);
                return;
            }
            
            g_arrMessageMeta = arrMeta_a;
            decodeMessagesForPage();
        }, 
        function(strError_a) 
        {
            console.error("Failed to fetch messages:", strError_a);
            alert("Failed to load messages: " + strError_a + "\nCheck console for details");
            showDropZone();
        }
    );
}

function getJSON(strUrl_a, cbSuccess_a, cbError_a) 
{
    makeAjaxRequest(strUrl_a, {}, function(strResponse_a) 
    {
        var arrParsed = JSON.parse(strResponse_a);
        cbSuccess_a(arrParsed);
    }, cbError_a);
}

function makeAjaxRequest(strUrl_a, objOptions_a, cbSuccess_a, cbError_a) 
{
    var objXhr = new XMLHttpRequest();
    var strMethod = objOptions_a.method;
    var strResponseType = objOptions_a.responseType;
    var objData = objOptions_a.data;
    
    if (!strMethod) 
    {
        strMethod = 'GET';
    }
    if (!strResponseType) 
    {
        strResponseType = 'text';
    }
    
    objXhr.open(strMethod, strUrl_a);
    objXhr.responseType = strResponseType;
    
    objXhr.onload = function() 
    {
        cbSuccess_a(objXhr.response);
    };
    
    objXhr.onerror = function() 
    {
        cbError_a(objXhr.statusText);
    };
    
    if (objData) 
    {
        objXhr.send(objData);
    } 
    else 
    {
        objXhr.send();
    }
}

// events

document.getElementById("txtServerUrl").addEventListener("input", function()
{
    g_strServerEndpoint = this.value.trim();
});

document.getElementById("btnRefresh").addEventListener("click", function()
{
	g_strChannelNumber = document.getElementById("txtChannelNumber").value.trim();
	fetchMessageMetas(g_intCurrentPage);
});

document.getElementById("btnSubmit").addEventListener("click", function()
{
	var intAddress;
	var intI;
	var strMessage = document.getElementById("txtMessage").value.trim();
	
	if (strMessage.length === 0)
	{
		alert("Please enter a message");
		return;
	}
	
	if (!g_arrUserRom)
	{
		alert("ROM not loaded");
		return;
	}
	
	var arrAddresses = [];
	for (intI = 0; intI < strMessage.length; intI++)
	{
		var strCharCode = strMessage.charCodeAt(intI);
		intAddress = getRandomAddressForChar(strCharCode);
		if (intAddress !== -1)
		{
			arrAddresses.push(intAddress);
		}
	}
	
	if (arrAddresses.length === 0)
	{
		alert("No characters from your message were found in the ROM");
		return;
	}
	
	g_strChannelNumber = document.getElementById("txtChannelNumber").value.trim();
	
	var arrBinary = new Uint8Array(arrAddresses.length * 2);
	for (intI = 0; intI < arrAddresses.length; intI++)
	{
		intAddress = arrAddresses[intI];
		arrBinary[intI * 2] = intAddress & 0xFF;
		arrBinary[intI * 2 + 1] = (intAddress >> 8) & 0xFF;
	}
	
	var objBlob = new Blob([arrBinary], {type: 'application/octet-stream'});
	var objFormData = new FormData();
	objFormData.append('addressfile', objBlob, 'message.bin');
	objFormData.append('channel', g_strChannelNumber);
	
	makeAjaxRequest(g_strServerEndpoint + "/index.php", 
		{method: 'POST', data: objFormData},
		function(objResponse_a)
		{
			console.log("Message submitted:", objResponse_a);
			document.getElementById("txtMessage").value = '';
			fetchMessageMetas(g_intCurrentPage);
		},
		function(strError_a)
		{
			console.error("Upload failed:", strError_a);
			alert("Failed to submit message: " + strError_a);
		}
	);
});

// Click to browse functionality
document.getElementById("divDropZone").addEventListener("click", function()
{
    document.getElementById("fileInput").click();
});

// Handle file selection from browse dialog
document.getElementById("fileInput").addEventListener("change", function(objEvent_a)
{
    var arrFiles = objEvent_a.target.files;
    if (arrFiles.length > 0)
    {
        var objFile = arrFiles[0];
        
        var objReader = new FileReader();
        objReader.onload = function(e)
        {
            g_arrUserRom = new Uint8Array(e.target.result);

            if (g_arrUserRom.length > 65536) 
            {
                g_arrUserRom = g_arrUserRom.slice(0, 65536);
            }
            
            buildCharacterMap();
            
            g_intCurrentPage = 1;
            fetchMessageMetas(g_intCurrentPage);
        };
        objReader.readAsArrayBuffer(objFile);
    }
});

document.getElementById("divDropZone").addEventListener("dragover", function(objEvent_a)
{
	objEvent_a.preventDefault();
	objEvent_a.target.classList.add("dragover");
});

document.getElementById("divDropZone").addEventListener("dragleave", function(objEvent_a)
{
	objEvent_a.preventDefault();
	objEvent_a.target.classList.remove("dragover");
});

document.getElementById("divDropZone").addEventListener("drop", function(objEvent_a)
{
	objEvent_a.preventDefault();
	objEvent_a.target.classList.remove("dragover");
	
	var arrFiles = objEvent_a.dataTransfer.files;
	if (arrFiles.length > 0)
	{
		var objFile = arrFiles[0];
		
		var objReader = new FileReader();
		objReader.onload = function(e)
		{
			g_arrUserRom = new Uint8Array(e.target.result);

			if (g_arrUserRom.length > 65536) 
			{
				g_arrUserRom = g_arrUserRom.slice(0, 65536);
			}
			
			buildCharacterMap();
			
			g_intCurrentPage = 1;
			fetchMessageMetas(g_intCurrentPage);
		};
		objReader.readAsArrayBuffer(objFile);
	}
});

document.getElementById("btnNext").addEventListener("click", function()
{
	g_intCurrentPage++;
	fetchMessageMetas(g_intCurrentPage);
});

document.getElementById("btnPrev").addEventListener("click", function()
{
	if (g_intCurrentPage > 1)
	{
		g_intCurrentPage--;
		fetchMessageMetas(g_intCurrentPage);
	}
});

showDropZone();
    </script>
</body>
</html>